name: Initialize CI environment
on:
  workflow_call:
    inputs:
      KEY:
        required: true
        type: string
      INSTALL_DEPENDENCIES:
        required: false
        type: boolean
        default: true
    secrets:
      REPO_ACCESS_TOKEN:
        required: true

jobs:
  clear_cache:
    name: Clear Cache
    runs-on: ubuntu-latest
    steps:
      - name: Clear cache
        uses: actions/github-script@v6
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        with:
          script: |
            console.log("About to clear")
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
            })
            for (const cache of caches.data.actions_caches) {
              if (cache.key.startsWith("${{ inputs.KEY }}")) {
                github.rest.actions.deleteActionsCacheById({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  cache_id: cache.id,
                })
              }
            }
            
  initialize:
    name: Initialize CI environment
    runs-on: ubuntu-latest
    needs: [clear_cache]
    steps:
    - name: Enable Corepack
      run: corepack enable
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
    - uses: actions/cache/restore@v4
      id: restore-cache-workspace
      with:
        path: ./*
        key: ${{ inputs.KEY }}-workspace
    - name: Install dependencies
      if: steps.restore-cache-workspace.outputs.cache-hit != 'true' && inputs.INSTALL_DEPENDENCIES == true
      run: yarn install
    - uses: actions/cache/save@v4
      if: steps.restore-cache-workspace.outputs.cache-hit != 'true'
      with:
        path: ./*
        key: ${{ inputs.KEY }}-workspace
